# Компиляция

### Качаем тулчейн
Для компиляции нужен `gcc-arm-none-eabi` скачивал по [статье на хабре](https://habr.com/ru/companies/timeweb/articles/787328/), кидал в чат в дс. Но процесс установки тут приведу.

```bash
ARM_TOOLCHAIN_VERSION=$(curl -s https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads | grep -Po '<h4>Version \K.+(?=</h4>)')
```

```bash
curl -Lo gcc-arm-none-eabi.tar.xz "https://developer.arm.com/-/media/Files/downloads/gnu/${ARM_TOOLCHAIN_VERSION}/binrel/arm-gnu-toolchain-${ARM_TOOLCHAIN_VERSION}-x86_64-arm-none-eabi.tar.xz"
```
```bash
sudo mkdir /opt/gcc-arm-none-eabi
```
```bash
sudo tar xf gcc-arm-none-eabi.tar.xz --strip-components=1 -C /opt/gcc-arm-none-eabi
```

У себя я его ставил не в `/opt` но в целом особо разницы нет. (Нюанс! Команды надо менять немного, т.к. афффтор забил на полную автоматизацию команд и если ставит не в /opt то в некоторых местах надо изменять адреса и дальше нужно заменять ник автора в путях на свой.)

### Перед использованием

Просто так тулы в PATH не попадают, так что их надо туда засунуть. Еще пару команд:

```bash
echo 'export PATH=$PATH:/opt/gcc-arm-none-eabi/bin' | sudo tee -a /home/megalloid/.bashrc
```
```bash
source /home/megalloid/.bashrc
```

После этого достаточно запустить `make` в папке с проектом и все будет хорошо. НО если что-то захочется скомпилить все самому, то нужно при вызове компилятора выставить флаги черной магии (че делают хз):

```bash
arm-none-eabi-gcc --specs=rdimon.specs main.c -o test
```

Поздравляю, до перезагрузки окружения у нас доступен компилятор.

# Собираем прочий инструментарий

## USB-UART переходник

Вооружаемся USB-UART или USB-TTL конвертором, соединяем TX к RX и наоборот, тыкаемся в порт и видим что ничего не видим. Для того чтобы хоть что-то увидеть юзаем `lsusb` там должно появиться подключенное устройство. У меня это **Bus 001 Device 003: ID 10c4:ea60 Silicon Labs CP210x UART Bridge**. Крайне вероятно что ничего похожего у вас не будет, скорее всего по 2 причинам: пользователь не находиться в группе dialout (или uucp (~~***I use ARCH btw***~~)) или у вас нет драйверов. Для ch342 они лежат в интернете, поставить их не сложно. Для того чтобы добавить юзера в группу юзаем (чтобы посмотреть в каких присутствуем `id -Gn`):
```bash
sudo usermod -a -G dialout $USER
```

## ST-Link 

Но нет, теперь надо тулзу для заливки проги через st-link. В указанной в начале статье все хорошо рассказано по установке, но я еще ловлю багу с линковкой либ из-за чего приходиться их чинить. [Ссылка на issue](https://github.com/stlink-org/stlink/issues/478) тут описано решение моей проблемы.

<details><summary>Починка библиотек</summary>
<code>
ldd /usr/local/bin/st-info
</code>

Видим неприлинкованную либу

<code>
export LD_LIBRARY_PATH=/usr/local/lib 
</code>

Указываем новый путь.
После новой проверки все будет ок (но опять же только в этом окружении).
</details> 

После этого можем запустить stlink-gui, подсоединиться к плате и залить прошивку (BIN файл из папки build) через FlashFirmware. Для теста нам нужно открыть сериал на комппе. Смотрим какой порт выдала система:
```bash
sudo dmesg | grep attached
```
У меня это выглядит так:
```
[ 2484.666688] usb 1-2.1: cp210x converter now attached to ttyUSB0
```
Включаем `putty` или любую другую любимую прогу для com портов и смотрим что нам туда летит.

Вместо `putty` для просмотра порта можно использовать, но это команда просто позволить посмотреть что что-то приходить, т.к. там ненастриваемый бодрейт (или я не знаю как ее правильно юзать (просто технически это чисто чтение из системного файла и не представляю что тут можно настроить))
```bash
cat -v /dev/ttyUSB0
```
Работает только если есть все права, их посмотреть можно
```bash
ls -lh /dev/tty0
```

Вместо использования GUI можно трушно использовать терминал, что на мой взгляд даже удобнее будет.

```bash
st-flash write ./build/HW3.bin 0x08000000   #залить прогу
ыt-flash reset  #перезагрузка камня
```

# Таки проект

### Нюансы

Генерируем код из **CubeMX** для конкретного проца. На занятии предлагали вырезать все лишние файлы, нооооо... Там все на хале держится так что я решил подзабить на это и просто компилировать проект через `make` и не думать об вырезании всего кроме инклудов, стартапа и линкера. 

### Все же начинаем

Все делается в `main` так что туда и лезем. Лежит в `Core/Src/main.c`.

Будем включать <details><summary>uart</summary> (точнее включили его еще в кубе, я решил не запариваться с вычислением бодрейта и подобного раз все равно куб есть а регистров мне еще на AVR хватило)</details> 
НО, опять чертовы но, какой включать!? У камня 4 асинхронных и 4 синхронных порта, и забурившись в доки и распиновку платы из куба выясняется что выведен в чистом виде только один и это USART6 на ножках ардуино шилда D0 и D1 (Для камня это PC7 (RX) и PC6 (TX) соответственно).

Для быстрого теста можно просто через `HAL_UART_Transmit(&huart6, &tx_buff, 1, 1000);` отправить символ и посмотреть что будет.

Переходим к регистрам. Для того чтобы как-то настроить UART придется его сначала включить, включить тактирование, настроить бодрейт и порты. Все это выполняет этот код:
```cpp
RCC->APB2ENR |= RCC_APB2ENR_USART6EN; //включить тактирование
GPIOC->MODER |= (2<<14);   // переводим PC7 в альтернативный режим
GPIOC->MODER |= (2<<12);
GPIOC->AFR[0] |= (8<<24);   //выбираем альтернативную функцию 8, т.е. uart 
GPIOC->AFR[0] |= (8<<28);
USART6->BRR = 0x8B;         //BRR для бодрейта 115200 при оверсемплиге 8
USART6->CR1 |= (1 << 0);    //включаем uart
USART6->CR1 |= (1 << 3);    //включаем transmitter
```

В регистре CR1 также находиться вся настройка остального хлама, но положения по 0 вполне достаточно сейчас, для особо одаренных есть [даташит](../Docs/rm0385-stm32f75xxx-and-stm32f74xxx-advanced-armbased-32bit-mcus-stmicroelectronics-1.pdf) на 2000 страниц со всем описанием МК.

Теперь отправка данных. Тут все просто, достаточно записать данные в `TDR` регистр и немного подождать. Тогда в `while` все будет так:

```cpp
USART6->TDR = 'a';  //отправляем а в буферный регистр
HAL_Delay(1000);
```

Теперь можно все собрать, залить и в теории все будет работать.