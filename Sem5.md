# OS vs SuperLoop

## SuperLoop

Вещь простая и очевидная, просто `while(true)` в котором происходит вся обработка. Из плюсов он простой и не занимает много кода. Минусы, если надо обеспечить интерактивность или обработку двух+ больших задач то происходит множество проблем, т.к. приходиться постоянно ручками переключать таски и подобное.

## OS

Кроме 2+ наших тасков создается еще таска-планировщик. Она вызывается по прерыванию (допустим таймеру) и решает кто будет выполняться дальше. Также он производит переключение контекста, т.к. в мк у нас нет виртуальной памяти то для переключения контекста достаточно сохранить регистры (среди них PS и SP регистры которы определяют память). 

Из нюансов по ABI нам аппаратно сохраняют только первые 8 регистры, т.е xPSR, PC, LR, R12, R0-R3. Остальные же надо сохранять программно, чем и занимается планировщик, кроме определения кто будет выполняться дальше. Регистры сохраняются на стек текущей таски (стек каждой таски часть пользовательского стека PSP, сам же планировщик выполняется в привилегированном режиме и у него свой стек и свой стек-поинтер msp), на ее psp и с нее же потом восстанавливается.

У нас нет как в серьезных операционках `fork` и подобного, такси создаем вручную, положви в структуру таски `task_t` вершину ее стека и заполнив начало массива, олицетворяющему ее стек.  