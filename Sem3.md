# Наконец STM
## Старт МК
При подаче питания генерируется RESET сигнал. <br>
Также RESEt может дернуть IWDG (как пример резет если прога зависла) и WWDG (что-то сложнее) (вочдоги).<br>

Запуск начинается с адреса 0x0000000 где лежит резет вектор и таблица прерываний. После этого стартует startap-scrypt (sturtup_stm32f4xx.s) которой перекидывает нужные переменные (**.data**) в RAM и инициализирует регистры.<br>
Также еще несколько блоков памяти:<br>

#### FLASH

- **.data** переменные
- **.rodata** константы
- **.text** код

#### RAM

- **.bss** инициализированные 0 переменные
- **.data** переменные

После этого запускается линкер (STM32F4xxNGHx_FLASH.ld).

Для компиляции нужен основной код, стартап и линкер из чего получаем ELF файл и его грузим на камень.

## Тактирование

Есть встроенные, но изначально вся переферия не подключена к тактированию. CubeMX на карте тактирования просто выставляет нужные биты в RCC (классе?структуре).

Про GPIO: режимы вывода Push_Pull, Opendrain и disabled. На каждый пин по 2 бита на режим.<br>

Пример:
> ***RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN*** тактирование GPIO <br>
> ***RCC->APB2ENR |= RCC_APB2ENR_USART1EN*** тактирование UART

##### GPIOx_MODER:

- **00** input
- **01** GP output mode
- **10** Alternative function (UART as example)
- **11** Analog mod

Пример:
> ***GPIOI->MODER |= (0b01<<2);***

##### GPIOx_PUPDR:

- **00** open drain
- **01** Pull-up
- **10** Pull-down

##### GPIOx_IDR:

Input data

Пример:
> ***while ((GPIOI->IDR & (1 << 11)) != (1<< 11));***

##### GPIOx_ODR:

Output data

Пример:
> ***GPIOI->BSRR |= (1<<1);***

#### UART

Есть общая кодировка 8-N-1 или подобное (N - нет бита четности, 1 - размер стоп бита, 8 - хз). <br>
Для бод рейта есть формула: **F**clk/USARTDIV

**USART_RDR** receave

**USART_TDR** transmit

**USART1->BRR** делитель

Данные для отправки не сразу идет на отправку, а через shift регистр чтобы не следить за освобождением TDR.

Также есть дофига регистров флагов которые можно считать для понимаю состояния переферии.

## Как собрать\сделать проект без IDE

Без CubeMx никак. Нужен будет для получения стартапа, линкера и настройки тактирвоания. Для "честной сборки" выбираем камень,создаем проект, включаем переферию и тактирование, выбираем MAKEFILE как IDE.
Берем стартап скрипть, линкер, make и нужные инклуды и как-то ебемся дпльше.
